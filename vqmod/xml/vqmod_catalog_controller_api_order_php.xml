<?xml version="1.0" encoding="UTF-8"?>
<modification>
    <id>Replace the css property in heading title in Shipping method step</id>
    <version>1.0</version>
    <vqmver>2.X</vqmver>
    <author>Tuts+</author>
    <file name="catalog/controller/api/order.php">
        <operation info="Replace the css property in heading title in Shipping method step">
            <search position="replace"><![CDATA[
                public function delete() {
            ]]></search>
            <add><![CDATA[
                function updateBpostOrder($order_id, $order_status_id){
                    $status_arr = array(
                        9   => 'OPEN',
                        2   => 'OPEN',
                        1   => 'PENDING',
                        7   => 'CANCELLED',
                        11  => 'CANCELLED',
                        12  => 'CANCELLED',
                        8   => 'CANCELLED',
                        14  => 'CANCELLED',
                        10  => 'CANCELLED',
                        13  => 'CANCELLED',
                        5   => 'OPEN',
                        15  => 'OPEN',
                        13  => 'OPEN',
                        16  => 'OPEN',
                        1   => 'ON-HOLD'
                    );
                    $ch = curl_init();
                    $bpost_id = $this->model_checkout_order->getBpostOrder($order_id);

                    if($bpost_id){
                        $webserviceUrl = 'https://api.bpost.be/services/shm/107413/orders/status';
                        $data = '<orderStatusMap xmlns="http://schema.post.be/shm/deepintegration/v2/">
                                  <entry>
                                    <orderReference>'.$bpost_id.'</orderReference>
                                    <status>'.$status_arr[$order_status_id].'</status>
                                  </entry>
                                </orderStatusMap>';
                        curl_setopt_array($ch,array (
                            CURLOPT_SSL_VERIFYPEER=>false,				// Make sure to trust the HTTPS certificate.
                            CURLOPT_HTTPAUTH=>CURLAUTH_BASIC,			// Use Basic Authentication.
                            CURLOPT_TIMEOUT=>30,						// Maximum number of seconds to allow cURL functions to execute.
                            CURLOPT_RETURNTRANSFER=>true,				// Return the output of the curl_exec() as a string, for display on screen in this example.
                            CURLOPT_FAILONERROR=>true,					// So we can do our own error handling.
                            CURLOPT_URL=>$webserviceUrl,
                            CURLOPT_HTTPHEADER=>array('Content-type: application/vnd.bpost.shm-order-status-v2+XML', 'X-HTTP-Method-Override: PATCH', 'charset: UTF-8'),	// Set the correct HTTP header.
                            CURLOPT_POSTFIELDS=>$data,
                            CURLOPT_USERPWD=>'107413:DEMO_SHM'	// Username and Password used for basic authentication.

                        ));
                        curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'PUT');
                        curl_setopt($ch, CURLOPT_HEADER, true);
                        $return = curl_exec($ch);
                        if (curl_errno($ch)) {
                            $result = 'ERROR -> ' . curl_errno($ch) . ': ' . curl_error($ch);
                        }
                        curl_close($ch);
                    }
                }


                public function delete() {
            ]]></add>
        </operation>
        <operation info="Replace the css property in heading title in Shipping method step">
            <search position="replace"><![CDATA[
                $this->model_checkout_order->addOrderHistory($order_id, $order_status_id);
            ]]></search>
            <add><![CDATA[
                $this->model_checkout_order->addOrderHistory($order_id, $order_status_id);
                $this->updateBpostOrder($order_id, $order_status_id);
            ]]></add>
        </operation>
    </file>
</modification>